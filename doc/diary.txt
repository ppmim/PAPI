PAPI DEVELOPER DIARY
====================

2011-10-24
----------


2011-10-25
----------
- Implemented in cube.c the next sky models:

     cube_median_min ( N )
     cube_mean_min ( N )
     cube_mean_min_w ( N )  weighted

 and modified the skyfilter.c routine in order to accept a new (optional)
 parameter 'skymodel' for the skyfiltering stage. The current accepted values
 for skymodel are:
     
     median : median/mean skymodel (normal or sparse fields)
     min : minimal sky model (for crowded fields)


- Al reducir la el DS de 13-Julio-2011-Matilde de O2k en el filtro Z
  (18:25:15+00:10:15) de 5 imágenes, observo que hay una reflejo que parece
  originado fuera del campo; le pregunto a Matilde, y buscando en 
http://archive.stsci.edu/cgi-bin/dss_form comprobamos que se debe a una
  estrella muy brillante que hay cerca del campo, y aunque no cae en el
  detector, lo que estamos viendo probablemente sean los arcos de difracción
  que genera la luz de la estrella en la óptica del telescopio/instrumento y
  que son vistos por el detector.
  
  Según Matilde, a priori, no sabe o no cree que eso se pueda eliminar
  facilmente, así que no habrá que preocuparse de momento por eso. 

  De todas formas, yo creo que con los skyflats(superflats) debería de haberse
  eliminado, no ?? pues están observando la misma zona del cielo...pero noooo,
  pues están cayendo sobre distintos píxeles, por lo que no hay nada que
  hacer, no ?? de todas formas tendría que ver si con alguna técnica de
  fringing removal se podría hacer algo ....

- Modificado genLogsheet para que pueda mostrar un subconjuto de filas y que
  además se pueda omitir la cabecera; todo esto con el objetivo de poder crear
  ficheros que puedan leer datasimy.py y createSeq.py



2011-10-26
----------

- Me suscribo a 3 listas de python, una de ellas en español ! para intentar
  estar un poco más actualizado del mundo Python. 

- Me pongo a buscar el bug que encontré al ejecutar el Test#23;
  Encotrado BUG sintáctico, estaba en ClFits.isScience()
 
- Me encuentro con otro/s bug/s a la hora de agrupar los datos:

     1) los master creados tienen un PAT_NEXP != N, y PAT_EXPN=1, con lo cual
     son confundidos/mezclados con los datos agrupados, provocando además que
     se queden fuera algunos ficheros que tendrían que ser agrupados.
     Para solucionar esto hago lo siguiente:

     	  - modifico las rutinas de creación de master para que actualicen el
                 valor de PAT_NEXP=1
	  - modifico en dataset.GetSeqFilesB() para que no tenga en cuenta a
                 la hora de agrupar los ficheros de tipo MASTER_XXXXX
		      

     2) En las rutinas de creación de masters, no se actualiza la keyword
     IMAGETYP, con lo cual PAPITYPE dice una cosa y IMAGETYP dice otro. Aunque
     PAPITYPE tiene prioridad, lo arreglo para que ambas digan lo mismo,
     aunque lo correcto sería eliminar IMAGETYP....

  
- Me surge la duda siguiente: ¿ qué debe tener más prioridad, un master dado
  de forma externa o uno creado por el propio pipeline como resultado de la
  reducción de la secuencia correspondiente ?
  Yo creo que debería tener prioridad el que reciba de forma externa ...pero
  tampoco lo tengo muy claro. Ahora el problema está en como implementar esa
  prioridad ....
  Se me ocurre, que vamos a tomar aquel que sea más reciente, mirando para
  ello la MJD --> usando el índice -1 de Python es sencillo.
  Para ello modifico RS.getCalibFor() de forma que devuelva el último elemento
  de la lista de master encontrados, que se supone será el más reciente.

- Modificación en el QL para que si no se ha activado la checkBox del outDir,
  se añadan las salidas generadas durante el procesamiento de los distintos
  datasets, básicamente para posibilitar que un science-DS pueda usar los
  master de calibración que hayan podido encontrarse y creado anteriormente.
  Para ello se modificó : MainGUI::checkLastTask()

- 
 
- Realizo los test #23-#30; destaco el test 30 que incluye a datos según el
  formato de GEIRS, que tienen que ser "convertidos" a 4 x (simple FITS) que
  puedan luego ser procesados por PAPI. Parece que de momento la cosa va bien,
  aunque aún queda por comprobar con datos reales si la astrometría de las
  nuevas imágenes creadas al partir el fichero original de GEIRS es correcta o
  no....

2011-10-27
----------


- Ejecutando el test #31, que fue bien, me doy cuenta de que por ejemplo, si
  para reducir una secuencia necesita alguna calibración con MJD posterior, la
  ordenación y ejecución de la reducción de secuencias no funcionaria, pues no
  la habría reducido todavía cuando es necesitada por una secuencia en
  cuestión. Es decir, sin en el test #31, los darks son posteriores a los
  twflats, da un ERROR diciendo que no encuentra el master dark necesario y
  que por tanto no puede crear el master TWFlat.

  Una posible solución que se me ocurre: que la ordenación de secuencias a
  procesar siga el criterio siguiente:

  	   	1- ordenar por MJD
		2- ordenar por DARK, DOME_FLATS, TW_FLATS, SCIENCE

  Para implementar esta solución añadi la funcion RS:reorder_sequences(), que
  hace justamente eso. La probé con el test #32 y funcionó correctamente. No
  obstante, llamo a esta función de reordenación a la hora de la reducción del
  RS, pero no cuando se muestra en la consola las Seqs encuentradas, más que
  nada para poder verlas ordenadas temporalmente.

  Obviamente, esto no es válido para el QL, pues en el QL se reducen las
  imágenes según van llegando...aunque pensandolo bien, también se podría usar
  cuando el usuario selecciona manualmente una sequencia de SCI y quiere que
  esté disponibles las calibraciones posteriores. Pero pensandolo mejor, es
  preferible que el usuario tenga que marcar/seleccionar todos aquellos
  ficheros que quiera tener en cuenta para la reducción o bien, indique
  explicitamente qué masterDark,masterFlat quiere usar.

- A raiz del tema de la ordenación de las sequencias y los problemas que puede
  dar en el QL si para reducir un SkyFlat no se han reducido aún los dark
  correspondientes, hago una modificación en QL para que avise también cuando
  no pueda reducir una secuencia, pues hasta ahora sólo avisava por la
  consola; ahora también muestra el mensaje en el Log de la GUI.
  Esto se puede probar con el test #32.


 
2011-11-02
----------

- Instalación de MV con openSuSE-11.1-64bit. Me dió bastantes problemas,
  entre:
	* primero de todo, al intentar instalar un SO guest de 64 bit,
  VirtualBox me avisa que tengo que habilitar en el BIOS del host principal el
  modo VT-x/AMD-v; no lo encontré en mi bios (DELL 390), pero había algo de
  virtualización y lo activé. A partir de ahí, VB me dejó instalar el SO 64bit.
	* me avisa de que el display del host es de 32 bit, pero que el guest
  está configurado con 16 bit--> eso no pasa nada, simplemente que para
  mejorar las prestaciones gráficas hay que instalar las GuestAdditions.
  	* Se me quedaba colgado al inicio de la instalación, y no sabía de qué
  podia ser; en un principio pensaba que era debido al mensaje de los 32/16
  bits del display, así que probé en modo texto (y seguia dicho mensaje), y
  fué cuando me di cuenta de que daba un error por el famoso ACPI. Para
  intentar solucionar esto desactivé en la definición de la máquina virtual la
  opción de ACPI. Con esto, ya me dejó instalar sin problemas.
  	* bueno, también se me quedó un par de veces colgada la instalación
por que no podía leer el DVD (incluso tampoco lo podia leer elwindowsXP), 
así que limpié varias veces el DVD hasta que volvió a leerlo sin problemas 
y pude instalar el openSuSE11.164bit.


 
- Implementación de apply_dark_flat=2
- Encontrado problema al ejecutar calTwFlat.py

2011-11-03
----------

- Encontrado y solucionado bug en calTwFlat.py --> el problema estaba en el
  parámetro input del mscred.flatcombine() que no estaba bien formado por el
  tema de la barra doble "//" que no acepta IRAF en los pathnames.

- Tras implementar el modo apply_dark_flat=2, hice las pruebas
  correspondientes y me dí cuenta de que tenía un error a la hora de crear el
  fichero stack1.pap en la llamada a coaddStackImages(). Tras solucinar dicho
  bug, todo parecía ir bien, aunque el test con datos de ALHAMBRA demostró que
  el FF después del skysubtraction (apply_dark_flat=2) es "como" (o sin el
  como) deshacer el skysubtraction, cosa que ya había comprobado en día
  anteriores y que coincide con lo que me decía Wei-Hao (SIMPLE).
  Por eso, realmente no le veo sentido a implementar dicho modo
  (apply_dark_flat=2), pero bueno, por si acaso...ya está implementado.

- Repito el test anterior (#32) con red_mode='science'


2011-11-04
==========

- Termino de instalar todo el software de PAPI en la Maquina Virtual (MV) de
  openSuSE que he creado eleborar el documento de instalación. 
  Al instalar la VBoxAdditions, me da un aviso de que parace que ya están
  instaladas en el SO guest, y que es mejor que no las re-instale, pero como
  tengo algunos problemas con el ratón y no tengo el FS para el mount.vboxfs
  para poder compartir carpetas con entre el host y el guest, pues no hago
  caso al aviso y dedido instalarlas. Después de un rato, re-compilando
  algunos módulos para el kernel y tal, pues todo parece terminar bien y
  funcionar correctamente. Veremos ....:-D

- Consigo finalmente instalar el binario (64bit) de SCAMPv1.7 y su dichosa
  dependencia de la libraria libplplot9; finalmente encuentro el RPM
  libplplot9-5.7.1-1.2.x86_64.rpm que se instala sin problemas.

2011-11-07
==========

- Videoconf PANIC: en cuanto al SW, aunque AGS dice que no está preparado y
  que prefiere postponer el viaje, JF insiste y dice que no se puede mover,
  así que finalmente iremos en el semana 47 como estaba previsto.
    

- Muevo el RS::reorder_sequences() al método  RS::getSequences  


2011-11-09
==========
- Defino algunos test para empezar las pruebas con AGS

- Asisto reunión convocada por Julio sobre HEXA

- Repito el test 18 con el Set HAWK-I-5, y obtengo un stitch final muy mal;
  miro los cuandrantes individiales Q0N y ninguno tiene la astrometría bien.
  Depurando, me doy cuenta de que SCAMP se queja (linea roja), y por eso no
  hace bien la astrometría con GSC-2.3.
  Cambio a 2MASS, y ahora la astrometría es buena !!! por qué ?? será que
  habré cambiado algún parámetro (NSIG en skyfilter, DETECT_THRESH, ...) ?
  La imagen final de los cuatro cuadrantes (stiched) está más o menos bien,
  con poca marca de la noise-cross-shape central.

- Inicio de pruebas integración OT-QL:


  
2011-11-10
==========

- Continuo pruebas de QL y depurando.
- Implemento eval_focus_serie.py, que basandose en checkQuality.py, calcula el
  mejor foco de una serie de foco. Lo pruebo con el ejemplo  de O2k que me
  pasó Ulli y funciona bien !!! Para el caso de PANIC, debería funcionar
  también sobre las imágnes 4kx4k, a pesar de la cruceta, pues SExtractor es
  robusto a eso...lo mejor sería simularlo y probarlo. 

- Por la tarde, hacemos algunas pruebas AGS y yo con el OT y el QL (ver
  documento manuscrito). Encontramos varios BUGS tanto en OT como QL.
  
  En OT: básicamente que no enumera bien las secuencias con el instrument
  iterator
  En QL: que no avisa de que un conjunto de ficheros no tiene ninguna
  secuencia, dando una exception "TypeError". (lo solucioné al día siguiente).

 


2011-11-11
==========

- Encuetro el bug del día anterior.
- Encuentro otro bug en eval_focus_serie, pues en los nuevos ficheros de PANIC
  el kw de foco telescopio se llama T_FOCUS en lugar de T-FOCUS. Modifico
  convenientemente la rutina.

- Comienzo diseño de DEMO PAPI/QL (papi_demo.txt)

- Tarde: AGS y yo continuamos con las pruebas de OT-QL:

  Basicamente hicimos un recorrido por el documento "WhatWeNeed.doc" de JF, y
  los principales fallos/problemas encontrados fueron:

      1) domeflats no tiene el orden on/off correcto, pues mezcla con los
      filtros. Lo correcto para una secuencia de 1-N sería
      on-on-on-off-off-off y seguir con el siguiente filtro.

      2) skyflats : no los podemos probar, pues no los tiene completamente
      implementados, pues el OT no tiene simulado el incremento artificial del
      número de cuentas.

      3) focur series: no implementado en OT, pero le doy el .prg y la idea de
      cómo hay que hacerlo. Intentará implementarlo para HD.

      4) simple exposure: no funciona ese caso particular

      5) nodding pattern: no implementado, pero le paso el sky_pointing.prg y
      cómo lo podría implementar. No cree que pueda tenerlo para HD.

      6) Pause: no está en OT, pero cree que lo podrá implementar, no es muy
      dificil.

  En cuanto al QL, no encontré errores, sólo lo siguientes comentarios:

      1) ver que nodding pattern puede contemplar PAPI ( y el OT) según las
      sugerencias de Ulli.

      2) ver que hace el QL/PAPI cuando encuentra dos PAT_EXPN=1 en una
      secuencia ????


