

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>photo.photometry &mdash; PAPI 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="PAPI 1.0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">PAPI 1.0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for photo.photometry</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module to do some photometry functionalities </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c">################################################################################</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># PAPI (PANIC PIpeline)</span>
<span class="c">#</span>
<span class="c"># photometry.py</span>
<span class="c">#</span>
<span class="c"># Tools used:</span>
<span class="c">#</span>
<span class="c">#    STILTS command line application  (http://www.star.bris.ac.uk/~mbt/stilts)</span>
<span class="c">#</span>
<span class="c"># Created    : 25/05/2011    jmiguel@iaa.es -</span>
<span class="c"># Last update: </span>
<span class="c"># TODO</span>
<span class="c">#       </span>
<span class="c">################################################################################</span>

<span class="c">################################################################################</span>

<span class="c"># Import necessary modules</span>
<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">atpy</span> 
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="c">#matplotlib.use(&#39;TkAgg&#39;)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.mlab</span> <span class="kn">as</span> <span class="nn">mlab</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="kn">as</span> <span class="nn">cm</span>
<span class="kn">import</span> <span class="nn">pylab</span>
            
<span class="kn">import</span> <span class="nn">catalog_query</span>

<span class="c"># Logging</span>
<span class="kn">from</span> <span class="nn">misc.paLog</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">import</span> <span class="nn">misc.utils</span>
<span class="kn">import</span> <span class="nn">astromatic</span>
<span class="kn">import</span> <span class="nn">datahandler</span>

<div class="viewcode-block" id="CmdException"><a class="viewcode-back" href="../../api.html#photo.photometry.CmdException">[docs]</a><span class="k">class</span> <span class="nc">CmdException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> 
    <span class="k">pass</span>


<span class="c">##################################</span>
<span class="c">### Some useful functions ########</span>
<span class="c">##################################       </span>
<span class="c">#from scipy.stats import norm, median</span>
<span class="c">#from scipy.stats.stats import nanmedian,_nanmedian</span></div>
<div class="viewcode-block" id="MAD"><a class="viewcode-back" href="../../api.html#photo.photometry.MAD">[docs]</a><span class="k">def</span> <span class="nf">MAD</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">0.6745</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Median Absolute Deviation along given axis of an array:</span>

<span class="sd">    median(abs(a - median(a))) / c</span>

<span class="sd">    c = 0.6745 is the constant to convert from MAD to std; it is used by</span>
<span class="sd">    default</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">good</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="n">a</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">good</span><span class="p">])</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">good</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="c"># I don&#39;t want the array to change so I have to copy it?</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aswp</span> <span class="o">=</span> <span class="n">swapaxes</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">good</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aswp</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">good</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">aswp</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</div>
<div class="viewcode-block" id="nanmedian"><a class="viewcode-back" href="../../api.html#photo.photometry.nanmedian">[docs]</a><span class="k">def</span> <span class="nf">nanmedian</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns median ignoring NAN</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">arr</span><span class="o">==</span><span class="n">arr</span><span class="p">])</span>


<span class="c">######### End of useful functions #################</span>
</div>
<div class="viewcode-block" id="catalog_xmatch"><a class="viewcode-back" href="../../api.html#photo.photometry.catalog_xmatch">[docs]</a><span class="k">def</span> <span class="nf">catalog_xmatch</span> <span class="p">(</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">,</span> <span class="n">out_format</span><span class="o">=</span><span class="s">&#39;votable&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mf">2.0</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    @summary: do catalogs cross-match</span>
<span class="sd">    </span>
<span class="sd">    @param cat1,cat2: catalogs for cross-matching</span>
<span class="sd">    @param err: max. error for finding objects within (arcseconds)</span>
<span class="sd">    @param out_filename: filename where results will be saved;if absent, </span>
<span class="sd">            the location will be a tempfile with a generated name</span>
<span class="sd">    @param out_format: format of the output generated; current options available </span>
<span class="sd">            are:</span>
<span class="sd">        - VO Table (XML) (votable) (default)</span>
<span class="sd">        - SVC (Software handshaking structure) message (svc)</span>
<span class="sd">        - ASCII table (ascii)</span>
<span class="sd">    @return: filename where results where saved (VOTABLE, ASCII_TABLE, ...)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">in1</span> <span class="o">=</span> <span class="n">cat1</span>
    <span class="n">in2</span> <span class="o">=</span> <span class="n">cat2</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out_filename</span>
    <span class="n">s_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="n">ar1</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">dec1</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">ar2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">dec2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    
    <span class="c"># del old instances</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    
    <span class="n">command_line</span> <span class="o">=</span> <span class="n">STILTSwrapper</span><span class="o">.</span><span class="n">_stilts_pathname</span> <span class="o">+</span> <span class="s">&quot; tskymatch2 &quot;</span> <span class="o">+</span> \
         <span class="s">&quot; in1=&quot;</span> <span class="o">+</span> <span class="n">in1</span> <span class="o">+</span> <span class="s">&quot; in2=&quot;</span> <span class="o">+</span> <span class="n">in2</span> <span class="o">+</span> <span class="s">&quot; out=&quot;</span> <span class="o">+</span> <span class="n">out</span> <span class="o">+</span> \
         <span class="s">&quot; error=&quot;</span> <span class="o">+</span> <span class="n">s_error</span>
          
    <span class="n">rcode</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">runCmd</span><span class="p">(</span><span class="n">command_line</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">rcode</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Some error while running command: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command_line</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CmdException</span><span class="p">(</span><span class="s">&quot;XMatch failed&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">out</span>   
</div>
<div class="viewcode-block" id="generate_phot_comp_plot"><a class="viewcode-back" href="../../api.html#photo.photometry.generate_phot_comp_plot">[docs]</a><span class="k">def</span> <span class="nf">generate_phot_comp_plot</span> <span class="p">(</span> <span class="n">input_catalog</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">expt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="p">,</span> 
                              <span class="n">out_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">out_format</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    @summary: generate a photometry comparison plot, comparing instrumental magnitude</span>
<span class="sd">              versus 2MASS photometry</span>
<span class="sd">    </span>
<span class="sd">    @param catalog : VOTABLE catalog  having the photometric values (instrumental and 2MASS);</span>
<span class="sd">    @param filter : NIR wavelength filter (J,H,K,Z)</span>
<span class="sd">    @param expt : exposure time of original input image; needed to </span>
<span class="sd">                compute the Instrumental Magnitude (Inst_Mag)  </span>
<span class="sd">    @param out_filename: filename where results will be saved;if absent, </span>
<span class="sd">            the location will be a tempfile with a generated name</span>
<span class="sd">    @param out_format: format of the output generated; current options available are:</span>
<span class="sd">        - &#39;pdf&#39; (default)</span>
<span class="sd">        - &#39;jpg&#39; </span>
<span class="sd">        - &#39;gif&#39;</span>
<span class="sd">        - for more formats, see  http://www.star.bris.ac.uk/~mbt/stilts/sun256/plot2d-usage.html</span>
<span class="sd">        </span>
<span class="sd">    @return: filename where results where saved (VOTABLE, ASCII_TABLE, ...)</span>
<span class="sd">    </span>
<span class="sd">    @note: &gt; stilts tpipe  ifmt=votable cmd=&#39;addcol MyMag_K &quot;-2.5*log10(FLUX_BEST/46.0)&quot;&#39; omode=out in=/home/panic/SOFTWARE/STILTS/match_double.vot out=match_D_b.vot</span>
<span class="sd">           &gt; stilts plot2d in=match_S_b.vot subsetNS=&#39;j_k&lt;=1.0 &amp; k_snr&gt;10&#39; lineNS=LinearRegression xdata=k_m ydata=MyMag_k xlabel=&quot;2MASS k_m / mag&quot; ylabel=&quot;PAPI k_m / mag&quot;</span>


<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;entering in &lt;generate_phot_comp_plot&gt;&quot;</span><span class="p">)</span>
    <span class="c">## 1 - First, we add a column with the Instrumental magnitude, computed as:</span>
    <span class="c">##    inst_mag = -2.5 log10(FLUX_BEST/TEXP)</span>
    <span class="c">## where FLUX_BEST is obtained from SExtractor output catalog</span>
    
    <span class="nb">input</span> <span class="o">=</span> <span class="n">input_catalog</span>
    <span class="n">output_1</span> <span class="o">=</span><span class="s">&quot;/tmp/output_1.xml&quot;</span>
    
    <span class="n">command_line</span> <span class="o">=</span> <span class="n">STILTSwrapper</span><span class="o">.</span><span class="n">_stilts_pathname</span> <span class="o">+</span> <span class="s">&quot; tpipe &quot;</span> <span class="o">+</span> \
                    <span class="s">&quot; ifmt=votable&quot;</span> <span class="o">+</span> \
                    <span class="s">&quot; cmd=&#39;addcol Inst_Mag </span><span class="se">\&quot;</span><span class="s">-2.5*log10(FLUX_BEST/</span><span class="si">%f</span><span class="s">)</span><span class="se">\&quot;</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">expt</span> <span class="o">+</span> \
                    <span class="s">&quot; omode=out&quot;</span> <span class="o">+</span> <span class="s">&quot; in=&quot;</span> <span class="o">+</span> <span class="nb">input</span> <span class="o">+</span> <span class="s">&quot; out=&quot;</span> <span class="o">+</span> <span class="n">output_1</span>

    <span class="n">rcode</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">runCmd</span><span class="p">(</span><span class="n">command_line</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">rcode</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_1</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Some error while running command: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command_line</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CmdException</span><span class="p">(</span><span class="s">&quot;STILTS command failed !&quot;</span><span class="p">)</span>
    
        
    <span class="c">## 2 - Secondly, generate the plot for photometric comparison</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">output_1</span>
    <span class="c">#command_line = STILTSwrapper._stilts_pathname + &quot; plot2d &quot; + \</span>
    <span class="c">#                &quot; in=&quot; + input + \</span>
    <span class="c">#                &quot; subsetNS=&#39;j_k&lt;=1.0 &amp; k_snr&gt;10&#39;  lineNS=LinearRegression&quot; + \</span>
    <span class="c">#                &quot; xdata=k_m ydata=Inst_Mag xlabel=\&quot;2MASS K_m / mag\&quot; &quot; + \</span>
    <span class="c">#                &quot; ylabel=\&quot;Instrumental_Mag K / mag\&quot; &quot; </span>
                     
    <span class="n">command_line</span> <span class="o">=</span> <span class="n">STILTSwrapper</span><span class="o">.</span><span class="n">_stilts_pathname</span> <span class="o">+</span> <span class="s">&quot; plot2d &quot;</span> <span class="o">+</span> \
                    <span class="s">&quot; in=&quot;</span> <span class="o">+</span> <span class="nb">input</span> <span class="o">+</span> \
                    <span class="s">&quot; subsetNS=&#39;h_snr&gt;10 &amp;&amp; j_snr&gt;10 &amp;&amp; FLAGS==0&#39;  lineNS=LinearRegression&quot;</span> <span class="o">+</span> \
                    <span class="s">&quot; ydata=</span><span class="si">%s</span><span class="s"> xdata=MAG_AUTO ylabel=</span><span class="se">\&quot;</span><span class="s">2MASS </span><span class="si">%s</span><span class="s"> / mag</span><span class="se">\&quot;</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span><span class="nb">filter</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="s">&quot; xlabel=</span><span class="se">\&quot;</span><span class="s">Instrumental_Mag </span><span class="si">%s</span><span class="s">/ mag</span><span class="se">\&quot;</span><span class="s"> &quot;</span><span class="o">%</span><span class="nb">filter</span>
                                     
    <span class="k">if</span> <span class="n">out_filename</span> <span class="p">:</span>
        <span class="n">command_line</span> <span class="o">+=</span> <span class="s">&quot; ofmt=&quot;</span> <span class="o">+</span> <span class="n">out_format</span> <span class="o">+</span> <span class="s">&quot; out=&quot;</span> <span class="o">+</span> <span class="n">out_filename</span>
                    
    <span class="n">rcode</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">runCmd</span><span class="p">(</span><span class="n">command_line</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">rcode</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Some error while running command: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command_line</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CmdException</span><span class="p">(</span><span class="s">&quot;STILTS command failed !&quot;</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">out_filename</span><span class="p">:</span> <span class="k">return</span> <span class="n">out_filename</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;stdout&#39;</span>

</div>
<div class="viewcode-block" id="compute_regresion"><a class="viewcode-back" href="../../api.html#photo.photometry.compute_regresion">[docs]</a><span class="k">def</span> <span class="nf">compute_regresion</span> <span class="p">(</span> <span class="n">vo_catalog</span><span class="p">,</span> <span class="n">column_x</span><span class="p">,</span> <span class="n">column_y</span> <span class="p">,</span> 
                        <span class="n">output_filename</span><span class="o">=</span><span class="s">&quot;/tmp/linear_fit.pdf&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    @summary: Compute and Plot the linear regression of two columns of the </span>
<span class="sd">              input vo_catalog</span>
<span class="sd">    @param column_x: column number for X values of the regression (MAG_AUTO)</span>
<span class="sd">    @param column_y: column number for Y values of the regression ( 2MASS </span>
<span class="sd">                     column name for photometric value )</span>
<span class="sd">    </span>
<span class="sd">    @return: tuple with linear fit parameters and a Plot showing the fit</span>
<span class="sd">             a - intercept </span>
<span class="sd">             b - slope of the linear fit</span>
<span class="sd">             r - estimated error</span>
<span class="sd">             </span>
<span class="sd">             None if happen some error  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">atpy</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">vo_catalog</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Canno&#39;t read the input table&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="c"># ToBeDone</span>
    <span class="c">## Filter data by FLAGS=0, FLUX_AUTO&gt;0, ...</span>
    <span class="c">## SNR = FLUX_AUTO / FLUXERR_AUTO</span>
    <span class="n">min_snr</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">table_new</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">FLUX_BEST</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">j_snr</span><span class="o">&gt;</span><span class="n">min_snr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">h_snr</span><span class="o">&gt;</span><span class="n">min_snr</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">k_snr</span><span class="o">&gt;</span><span class="n">min_snr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">j_k</span><span class="o">&lt;</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">FLUX_AUTO</span><span class="o">/</span><span class="n">table</span><span class="o">.</span><span class="n">FLUXERR_AUTO</span><span class="o">&gt;</span><span class="n">min_snr</span><span class="p">))</span>
    
    <span class="c"># If there aren&#39;t enough 2MASS objects, don&#39;t use color cut</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table_new</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">25</span><span class="p">:</span>
        <span class="c">#table_new = table.where( (table.FLAGS==0) &amp; (table.FLUX_BEST &gt; 0) &amp;</span>
        <span class="c">#                         (table.j_snr&gt;min_snr))</span>
        <span class="n">table_new</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">FLUX_BEST</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">j_snr</span><span class="o">&gt;</span><span class="n">min_snr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">h_snr</span><span class="o">&gt;</span><span class="n">min_snr</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">k_snr</span><span class="o">&gt;</span><span class="n">min_snr</span><span class="p">)</span> <span class="o">&amp;</span> 
                             <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">FLUX_AUTO</span><span class="o">/</span><span class="n">table</span><span class="o">.</span><span class="n">FLUXERR_AUTO</span><span class="o">&gt;</span><span class="n">min_snr</span><span class="p">))</span>
        
    <span class="c">#X = -2.5 * numpy.log10(table_new[&#39;FLUX_AUTO&#39;]/1.0)</span>
    <span class="nb">filter</span> <span class="o">=</span> <span class="n">column_y</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">table_new</span><span class="p">[</span><span class="n">column_x</span><span class="p">]</span> <span class="c"># MAG_AUTO = -2.5 * numpy.log10(table_new[&#39;FLUX_AUTO&#39;]/1.0)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">table_new</span><span class="p">[</span><span class="n">column_y</span><span class="p">]</span> <span class="c"># 2MASS photometric value</span>
   
   
    <span class="c">#remove the NaN values </span>
    <span class="n">validdata_X</span> <span class="o">=</span> <span class="o">~</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">validdata_Y</span> <span class="o">=</span> <span class="o">~</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">validdataBoth</span> <span class="o">=</span> <span class="n">validdata_X</span> <span class="o">&amp;</span> <span class="n">validdata_Y</span>
    <span class="n">n_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">validdataBoth</span><span class="p">]</span> <span class="c">#- (0.5*0.05) # a row extinction correction</span>
    <span class="n">n_Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">validdataBoth</span><span class="p">]</span> 

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_X</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_Y</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Not enought number of data, only </span><span class="si">%d</span><span class="s"> points found&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">n_X</span><span class="p">))</span>

    <span class="c"># Compute the linear fit</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">n_X</span><span class="p">,</span> <span class="n">n_Y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c"># intercept == Zero Point</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c"># slope</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c"># regression coeff ??? not exactly</span>
    
    <span class="k">print</span> <span class="s">&quot;Coeffs =&quot;</span><span class="p">,</span> <span class="n">res</span>
    
    <span class="c"># Plot the results</span>
    <span class="n">pol</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_X</span><span class="p">,</span> <span class="n">n_Y</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="n">n_X</span><span class="p">,</span> <span class="n">pol</span><span class="p">(</span><span class="n">n_X</span><span class="p">),</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Filter </span><span class="si">%s</span><span class="s">  -- Poly fit: </span><span class="si">%f</span><span class="s"> X + </span><span class="si">%f</span><span class="s">  r=</span><span class="si">%f</span><span class="s"> ZP=</span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Inst_Mag (MAG_AUTO) / mag&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;2MASS Mag  / mag&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Zero Point (from polyfit) =</span><span class="si">%f</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    
    
    <span class="c"># Compute the ZP as the median of all per-star ZP=(Mag_2mass-Mag_Inst)</span>
    <span class="n">zps</span> <span class="o">=</span> <span class="n">n_Y</span> <span class="o">-</span> <span class="n">n_X</span> 
    <span class="n">zp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span>
    <span class="c">#zp = a</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Initial ZP(median) = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">zp</span><span class="p">)</span>
    <span class="n">zp_sigma</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span>
    <span class="c">#print &quot;ZPS=&quot;,zps</span>
    <span class="c"># do a kind of sigma-clipping</span>
    <span class="n">zp_c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">zps</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zps</span><span class="o">-</span><span class="n">zp</span><span class="p">)</span><span class="o">&lt;</span><span class="n">zp_sigma</span><span class="o">*</span><span class="mi">2</span><span class="p">)])</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;ZP_sigma=</span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">zp_sigma</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Clipped ZP = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">zp_c</span><span class="p">)</span>
    <span class="n">zp</span> <span class="o">=</span> <span class="n">zp_c</span>
    <span class="c">#zp = a</span>
    
    <span class="c"># Now, compute the histogram of errors</span>
    <span class="n">m_err_for_radial_systematic</span> <span class="o">=</span> <span class="n">n_Y</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_X</span> <span class="o">+</span> <span class="n">zp</span><span class="p">)</span>
    <span class="n">n_X</span> <span class="o">=</span> <span class="n">n_X</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zps</span><span class="o">-</span><span class="n">zp</span><span class="p">)</span><span class="o">&lt;</span><span class="n">zp_sigma</span><span class="o">*</span><span class="mi">2</span><span class="p">)]</span>
    <span class="n">n_Y</span> <span class="o">=</span> <span class="n">n_Y</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zps</span><span class="o">-</span><span class="n">zp</span><span class="p">)</span><span class="o">&lt;</span><span class="n">zp_sigma</span><span class="o">*</span><span class="mi">2</span><span class="p">)]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Number of points = </span><span class="si">%d</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">n_X</span><span class="p">))</span>
    <span class="c">#m_err = n_Y - (n_X*b + zp ) </span>
    <span class="n">m_err</span> <span class="o">=</span> <span class="n">n_Y</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_X</span> <span class="o">+</span> <span class="n">zp</span><span class="p">)</span>
    <span class="n">rms</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span><span class="n">m_err</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">MAD</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m_err</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">m_err</span><span class="p">)))</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">m_err</span><span class="p">)</span>
    <span class="c">#std2 = numpy.std(m_err[numpy.where(numpy.abs(m_err)&lt;std*2)])</span>
    

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;ZP = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">zp</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;MAD(m_err) = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">MAD</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;MEAN(m_err) = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">m_err</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;MEDIAN(m_err) = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">m_err</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;STD(m_err) = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">std</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;RMS(m_err) = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rms</span><span class="p">)</span>
    <span class="c">#log.debug(&quot;STD2 = %f&quot;%std2)</span>
    
    <span class="c">#my_mag = n_X*b + zp</span>
    <span class="n">my_mag</span> <span class="o">=</span> <span class="n">n_X</span> <span class="o">+</span> <span class="n">zp</span>
    <span class="c">#plt.plot( my_mag[numpy.where(m_err&lt;std*2)], m_err[numpy.where(m_err&lt;std*2)], &#39;.&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="n">my_mag</span><span class="p">,</span> <span class="n">m_err</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Inst_Mag&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;2MASS_Mag-Inst_Mag&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;(1) Calibration with 2MASS - STD = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">std</span><span class="p">)</span>
    <span class="c">#plt.plot((b * n_X + a), m_err, &#39;.&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;/tmp/phot_errs.pdf&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c"># Plot radial distance VS m_err</span>
    <span class="n">radial_distance</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">table_new</span><span class="p">[</span><span class="s">&#39;X_IMAGE&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1024</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> 
                                 <span class="o">+</span> <span class="p">(</span><span class="n">table_new</span><span class="p">[</span><span class="s">&#39;Y_IMAGE&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1024</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.45</span> <span class="c">#arcsecs</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="n">radial_distance</span><span class="p">,</span> <span class="n">m_err_for_radial_systematic</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Radial distance (&#39;arcsec&#39;)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;2MASS_Mag-Inst_Mag&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;(1) Spatial systematics - STD = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">std</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;/tmp/espatial_systematics_errs.pdf&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    
    <span class="c"># Second ZP</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Second iteration&quot;</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">n_Y</span> <span class="o">-</span> <span class="n">n_X</span> 
    <span class="k">print</span> <span class="s">&quot;LEN1=&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;LEN2=&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m_err</span><span class="p">)</span><span class="o">&lt;</span><span class="n">std</span><span class="o">*</span><span class="mi">2</span><span class="p">)])</span>
    <span class="n">zp2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span> <span class="n">temp</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m_err</span><span class="p">)</span><span class="o">&lt;</span><span class="n">std</span><span class="o">*</span><span class="mi">2</span><span class="p">)])</span>
    <span class="n">m_err2</span> <span class="o">=</span> <span class="n">n_Y</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_X</span> <span class="o">+</span> <span class="n">zp2</span><span class="p">)</span> 
    <span class="n">rms2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span><span class="n">m_err2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">std2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">m_err2</span><span class="p">)</span>
    <span class="n">MAD2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m_err2</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">m_err2</span><span class="p">)))</span>
    <span class="n">MAD2b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span> <span class="p">(</span><span class="n">m_err2</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">m_err2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
    <span class="c">#std3 = numpy.std(m_err[numpy.where(numpy.abs(m_err2)&lt;std2*2)])</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;ZP2 = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">zp2</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;MAD2(m_err2) = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">MAD2</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;MAD2b(m_err2) = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">MAD2b</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;MEAN2(m_err2) = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">m_err2</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;STD(m_err2) = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">std2</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;RMS(m_err2) = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rms2</span><span class="p">)</span>

    <span class="c">#log.debug(&quot;STD3 = %f&quot;%std3)</span>
    
    
    

    <span class="c">#print m_err</span>
    <span class="c"># Lo normal es que coincida la RMS con la STD, pues la media de m_err en este caso es 0</span>
    <span class="n">my_mag</span> <span class="o">=</span> <span class="n">n_X</span><span class="o">+</span><span class="n">zp2</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="n">my_mag</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_err</span><span class="o">&lt;</span><span class="n">std</span><span class="o">*</span><span class="mi">2</span><span class="p">)],</span> <span class="n">m_err</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_err</span><span class="o">&lt;</span><span class="n">std</span><span class="o">*</span><span class="mi">2</span><span class="p">)],</span> <span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Inst_Mag&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;2MASS_Mag-Inst_Mag&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;(2) Calibration with 2MASS - STD = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">std2</span><span class="p">)</span>
    <span class="c">#plt.plot((b * n_X + a), m_err, &#39;.&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;/tmp/phot_errs.pdf&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    
    <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">m_err2</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Mag error Histogram - RMS = </span><span class="si">%f</span><span class="s"> mag STD = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">rms2</span><span class="p">,</span><span class="n">std2</span><span class="p">))</span>
    <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Mag error&quot;</span><span class="p">)</span>
    <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Frequency&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;/tmp/phot_hist.pdf&quot;</span><span class="p">)</span>
    <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    

    </div>
<div class="viewcode-block" id="STILTSwrapper"><a class="viewcode-back" href="../../api.html#photo.photometry.STILTSwrapper">[docs]</a><span class="k">class</span> <span class="nc">STILTSwrapper</span> <span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Make a wrapper to some functionalities of STILTS </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">cat_names</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;2MASS&#39;</span><span class="p">:</span><span class="s">&#39;fp_psc&#39;</span><span class="p">,</span> 
                <span class="s">&#39;USNOB1&#39;</span><span class="p">:</span> <span class="s">&#39;usno_b1&#39;</span><span class="p">,</span>
                <span class="s">&#39;IRAS&#39;</span><span class="p">:</span> <span class="s">&#39;iraspsc&#39;</span>
                     <span class="p">}</span>
    <span class="n">outfmt</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;votable&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
              <span class="s">&#39;ascii&#39;</span><span class="p">:</span> <span class="mi">1</span>
              <span class="p">}</span>
    
    <span class="c">#_stilts_pathname = &quot;/home/panic/SOFTWARE/STILTS/stilts&quot;</span>
    <span class="n">_stilts_pathname</span> <span class="o">=</span> <span class="s">&quot;/home/panicmgr/PAPI/downloads/STILTS/stilts&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The constructor &quot;&quot;&quot;</span>
        <span class="nb">super</span> <span class="p">(</span><span class="n">STILTSwrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span> <span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
        
    
<div class="viewcode-block" id="STILTSwrapper.runXMatch"><a class="viewcode-back" href="../../api.html#photo.photometry.STILTSwrapper.runXMatch">[docs]</a>    <span class="k">def</span> <span class="nf">runXMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">out_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">out_format</span><span class="o">=</span><span class="s">&#39;votable&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @summary: do catalogs cross-match</span>
<span class="sd">        </span>
<span class="sd">        @param cat1,cat2: catalogs for cross-matching</span>
<span class="sd">        </span>
<span class="sd">	@param err: max. error for finding objects within (arcseconds)</span>
<span class="sd">        </span>
<span class="sd">	@param out_filename: filename where results will be saved;if absent, </span>
<span class="sd">        the location will be a tempfile with a generated name</span>
<span class="sd">        </span>
<span class="sd">	@param out_format: format of the output generated; current options available are:</span>
<span class="sd">        - VO Table (XML) (votable) (default)</span>
<span class="sd">        - SVC (Software handshaking structure) message (svc)</span>
<span class="sd">        - ASCII table (ascii)</span>
<span class="sd">        </span>
<span class="sd">	@return: filename where results where saved (VOTABLE, ASCII_TABLE, ...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">in1</span> <span class="o">=</span> <span class="n">cat1</span>
        <span class="n">in2</span> <span class="o">=</span> <span class="n">cat2</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out_filename</span>
        <span class="n">s_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="n">ar1</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">dec1</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">ar2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">dec2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        
        <span class="n">command_line</span> <span class="o">=</span> <span class="n">STILTSwrapper</span><span class="o">.</span><span class="n">_stilts_pathname</span> <span class="o">+</span> <span class="s">&quot; tskymatch2 &quot;</span> <span class="o">+</span> \
             <span class="s">&quot; in1=&quot;</span> <span class="o">+</span> <span class="n">in1</span> <span class="o">+</span> <span class="s">&quot; in2=&quot;</span> <span class="o">+</span> <span class="n">in2</span> <span class="o">+</span> <span class="s">&quot; out=&quot;</span> <span class="o">+</span> <span class="n">out</span> <span class="o">+</span> \
             <span class="s">&quot; error=&quot;</span> <span class="o">+</span> <span class="n">error</span>
              
        <span class="n">rcode</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">runCmd</span><span class="p">(</span><span class="n">command_line</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">rcode</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Some error while running command: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command_line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out_filename</span>    
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ./stilts tskymatch2 in1=/tmp/alh_single.fits.xml in2=/tmp/prueba.xml out=match.xml error=2</span>
<span class="sd">        ./stilts tpipe  ifmt=votable cmd=&#39;addcol MyMag_K &quot;-2.5*log10(FLUX_BEST/46.0)&quot;&#39; omode=out in=/home/panic/SOFTWARE/STILTS/match_double.vot out=match_D_b.vot</span>
<span class="sd">        ./stilts plot2d in=match_S_b.vot subsetNS=&#39;j_k&lt;=1.0 &amp; k_snr&gt;10&#39; lineNS=LinearRegression xdata=k_m ydata=MyMag_k xlabel=&quot;2MASS k_m / mag&quot; ylabel=&quot;PAPI k_m / mag&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
</div></div>
<div class="viewcode-block" id="doPhotometry"><a class="viewcode-back" href="../../api.html#photo.photometry.doPhotometry">[docs]</a><span class="k">def</span> <span class="nf">doPhotometry</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span> <span class="n">catalog</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    @summary: Run the rough photometric calibraiton</span>
<span class="sd">    </span>
<span class="sd">    @param input_image: reduced science image</span>
<span class="sd">    </span>
<span class="sd">    @param catalog: photometric catalog to compare to</span>
<span class="sd">    </span>
<span class="sd">    @param output_filename: file where output figure will be saved  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="c">## 0.1 - Read the RA,Dec and TEXP values from the input image</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Reading FITS file EXPT, RA, Dec &amp; FILTER values ...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">my_fits</span> <span class="o">=</span> <span class="n">datahandler</span><span class="o">.</span><span class="n">ClFits</span><span class="p">(</span><span class="n">input_image</span><span class="p">)</span>
        <span class="n">exptime</span>  <span class="o">=</span> <span class="n">my_fits</span><span class="o">.</span><span class="n">expTime</span><span class="p">()</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">my_fits</span><span class="o">.</span><span class="n">ra</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">my_fits</span><span class="o">.</span><span class="n">dec</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="n">my_fits</span><span class="o">.</span><span class="n">getFilter</span><span class="p">()</span>
        
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;EXPTIME = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">exptime</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;RA = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;DEC = </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Filter = </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">filter</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ra</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">exptime</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Found wrong RA,DEC,EXPTIME or FILTER value&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Found wrong RA,Dec,EXPTIME or FILTER value.&quot;</span><span class="p">)</span>
        
        <span class="c"># Checking Filter    </span>
        <span class="k">if</span> <span class="nb">filter</span><span class="o">==</span><span class="s">&#39;J&#39;</span><span class="p">:</span>
            <span class="n">two_mass_col_name</span> <span class="o">=</span> <span class="s">&#39;j_m&#39;</span>
        <span class="k">elif</span> <span class="nb">filter</span><span class="o">==</span><span class="s">&#39;H&#39;</span><span class="p">:</span>
            <span class="n">two_mass_col_name</span> <span class="o">=</span> <span class="s">&#39;h_m&#39;</span>
        <span class="k">elif</span> <span class="nb">filter</span><span class="o">==</span><span class="s">&#39;K&#39;</span> <span class="ow">or</span> <span class="nb">filter</span><span class="o">==</span><span class="s">&#39;K-PRIME&#39;</span> <span class="ow">or</span> <span class="nb">filter</span><span class="o">==</span><span class="s">&#39;KS&#39;</span><span class="p">:</span>
            <span class="n">two_mass_col_name</span> <span class="o">=</span> <span class="s">&#39;k_m&#39;</span>   
        <span class="c">#elif filter==&#39;OPEN&#39;:</span>
        <span class="c">#    two_mass_col_name = &#39;j_m&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Filter </span><span class="si">%s</span><span class="s"> not supported&quot;</span> <span class="o">%</span><span class="nb">filter</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Filter </span><span class="si">%s</span><span class="s"> not supported&quot;</span><span class="o">%</span><span class="nb">filter</span><span class="p">)</span>
            
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Cannot read properly FITS file : </span><span class="si">%s</span><span class="s">:&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">e</span>
    
    <span class="c">## 0.2 - Generate image catalog (VOTable) -&gt; SExtractor</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;*** Creating SExtractor VOTable catalog ....&quot;</span><span class="p">)</span>
    
    <span class="c">#tmp_fd, tmp_name = tempfile.mkstemp(suffix=&#39;.xml&#39;, dir=os.getcwd())</span>
    <span class="c">#os.close(tmp_fd)</span>
    <span class="n">image_catalog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">input_image</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="s">&quot;.xml&quot;</span>
    
    <span class="n">sex</span> <span class="o">=</span> <span class="n">astromatic</span><span class="o">.</span><span class="n">SExtractor</span><span class="p">()</span>
    <span class="n">sex</span><span class="o">.</span><span class="n">ext_config</span><span class="p">[</span><span class="s">&#39;CHECKIMAGE_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;NONE&quot;</span>
    <span class="n">sex</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;CATALOG_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;ASCII_VOTABLE&quot;</span>
    <span class="n">sex</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;CATALOG_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_catalog</span>
    <span class="n">sex</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DETECT_THRESH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">sex</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DETECT_MINAREA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">sex</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;MAG_ZEROPOINT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">#26.56</span>
    
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sex</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span> <span class="n">updateconfig</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Canno&#39;t create SExtractor catalog : </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">e</span> 
            
    <span class="c">## 1 - Generate region of base catalog (2MASS)</span>
    <span class="n">icat</span> <span class="o">=</span> <span class="n">catalog_query</span><span class="o">.</span><span class="n">ICatalog</span> <span class="p">()</span>
    <span class="n">out_base_catalog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/catalog_region.xml&quot;</span>
    <span class="n">sr</span> <span class="o">=</span> <span class="mi">500</span> <span class="c"># arcsec</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res_file</span> <span class="o">=</span> <span class="n">icat</span><span class="o">.</span><span class="n">queryCatalog</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> 
                                     <span class="n">catalog_query</span><span class="o">.</span><span class="n">ICatalog</span><span class="o">.</span><span class="n">cat_names</span><span class="p">[</span><span class="s">&#39;2MASS&#39;</span><span class="p">],</span> 
                                     <span class="n">out_base_catalog</span><span class="p">,</span> <span class="s">&#39;votable&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Output file generated : </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res_file</span><span class="p">)</span> 
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Sorry, cann&#39;t solve the query to ICatalog: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">e</span>

    <span class="c">## 2- XMatch the catalogs (image_catalog VS just base_catalog generated)          </span>
    <span class="n">out_xmatch_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/xmatch.xml&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">match_cat</span> <span class="o">=</span> <span class="n">catalog_xmatch</span><span class="p">(</span> <span class="n">image_catalog</span><span class="p">,</span> <span class="n">res_file</span><span class="p">,</span> 
                                   <span class="n">out_xmatch_file</span><span class="p">,</span> <span class="n">out_format</span><span class="o">=</span><span class="s">&#39;votable&#39;</span><span class="p">,</span> 
                                   <span class="n">error</span><span class="o">=</span><span class="mf">1.0</span> <span class="p">)</span> 
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;XMatch done !&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;XMatch failed </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">e</span>
    
    <span class="c">## 3a- Compute the linear regression (fit) of Inst_Mag VS 2MASS_Mag</span>
    <span class="c">###### and generate the plot file with the photometric comparison</span>
    <span class="c">###### 2MASS_Mag = Inst_Mag*b + ZP  </span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Compute &amp; Plot regression !!!&quot;</span><span class="p">)</span>    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">compute_regresion</span> <span class="p">(</span><span class="n">out_xmatch_file</span><span class="p">,</span> <span class="s">&#39;MAG_AUTO&#39;</span><span class="p">,</span> 
                           <span class="n">two_mass_col_name</span><span class="p">,</span> <span class="n">output_filename</span> <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Well DONE !!&quot;</span><span class="p">)</span>
        <span class="c">#sys.exit(0)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Sorry, some error while computing linear fit or</span><span class="se">\</span>
<span class="s">        ploting the results: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">e</span>
    
    <span class="c">## 3b- Compute the linear regression (fit) of Inst_Mag VS 2MASS_Mag</span>
    <span class="c">###### and generate the plot file with the photometric comparison  </span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">exptime</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c"># SWARP normalize flux to 1 sec</span>
        <span class="n">file_ext</span> <span class="o">=</span> <span class="n">output_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">output_filename_2</span> <span class="o">=</span> <span class="n">output_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">file_ext</span><span class="p">,</span><span class="s">&quot;_2.&quot;</span><span class="o">+</span><span class="n">file_ext</span><span class="p">)</span> 
        <span class="n">plot_file</span> <span class="o">=</span> <span class="n">generate_phot_comp_plot</span> <span class="p">(</span> <span class="n">match_cat</span><span class="p">,</span> <span class="n">two_mass_col_name</span><span class="p">,</span> <span class="n">exptime</span><span class="p">,</span> 
                                              <span class="n">output_filename_2</span><span class="p">,</span> 
                                              <span class="n">out_format</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Plot file generated : </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">plot_file</span><span class="p">)</span> 
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Sorry, some error while computing linear fit or </span><span class="se">\</span>
<span class="s">        ploting the results: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">e</span>

    <span class="k">return</span> <span class="n">output_filename</span>

<span class="c">################################################################################</span>
<span class="c"># main</span>
<span class="c">################################################################################</span></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&#39;Testing Photometric calibration comparison with 2MASS&#39;</span><span class="p">)</span>
    
        <span class="c"># Get and check command-line options</span>
        
    <span class="n">usage</span> <span class="o">=</span> <span class="s">&quot;usage: %prog [options] arg1 arg2 ...&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span>
    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-i&quot;</span><span class="p">,</span> <span class="s">&quot;--input_image&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;input_image&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;input image to calibrate</span><span class="se">\</span>
<span class="s">                  to do photometric comparison with&quot;</span><span class="p">)</span>
                  
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;--base_catalog (2MASS, USNO-B)&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;base_catalog&quot;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&quot;Name of base catalog to compare with (2MASS, USNO-B) -- not used !!! (default = </span><span class="si">%d</span><span class="s">efault)&quot;</span><span class="p">,</span>
                  <span class="n">default</span><span class="o">=</span><span class="s">&quot;2MASS&quot;</span><span class="p">)</span>
    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-o&quot;</span><span class="p">,</span> <span class="s">&quot;--output&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;output_filename&quot;</span><span class="p">,</span> 
                  <span class="n">help</span><span class="o">=</span><span class="s">&quot;output plot filename (default = </span><span class="si">%d</span><span class="s">efault)&quot;</span><span class="p">,</span>
                  <span class="n">default</span><span class="o">=</span><span class="s">&quot;photometry.pdf&quot;</span><span class="p">)</span>
    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="s">&quot;--verbose&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&quot;verbose mode [default]&quot;</span><span class="p">)</span>
    
                                
    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">input_image</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> 
    <span class="c"># args is the leftover positional arguments after all options have been processed</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;wrong number of arguments &quot;</span> <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">output_filename</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">output_filename</span><span class="o">=</span><span class="bp">None</span>
    

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">input_image</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span> <span class="p">(</span><span class="s">&quot;Input image </span><span class="si">%s</span><span class="s"> does not exist&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">input_image</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="s">&quot;2MASS&quot;</span>
        <span class="n">doPhotometry</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">input_image</span><span class="p">,</span> <span class="n">catalog</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">output_filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Some error while running photometric calibration: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">PAPI 1.0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, J.M.Ibanez (IAA-CSIC).
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>